# 01

*Low-dose radiotherapy combined with dual PD-L1 and VEGFA blockade elicits antitumor response in hepatocellular carcinoma mediated by activated intratumoral CD8 exhausted-like T cells+*

<https://www.nature.com/articles/s41467-023-43462-1>

```{r}
library(tidyverse)
library(ggpubr)
library(ggsignif)
library(ggsci)
```

## waterfall barplot：Fig.1 c

```{r}
c <- read_excel("data/01source.xlsx",sheet=1,range = "A2:D16") |> 
  rename(
    LR_DPVB=`LR-DPVB`
  )  |> 
  pivot_longer(
    cols = CON:LR_DPVB,
    names_to = "treatment",
    values_to = "changerate"
  ) |> 
  mutate(
    treatment=factor(treatment,levels=c('CON','LDRT','DPVB','LR_DPVB')),
    changerate=if_else(changerate>=1,100,changerate*100)
  ) |> 
  arrange(treatment)|>
  drop_na() |> 
  mutate(
    id=1:52
    ) 
```

```{r}

ggplot( c ,aes(x=id,y=changerate,fill=treatment))+ 
  geom_bar(stat = "identity",position = "dodge",width =0.8)+
#  scale_fill_lancet()+
#  scale_fill_nejm()+
#  scale_fill_jama()+
    scale_fill_jco()+
    scale_y_continuous(name = "MRI tumor volume change from baseline (%)",
                       limits = c(-100,100),
                       breaks = seq(-100,100,50),
                       )+
    theme_pubr()+
    theme(
        legend.position = c(0.8,0.8),
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
    )+
    ggtitle("Hepa1-6 tumor")+
    geom_hline(yintercept = 0,color = "black",linetype =1,linewidth=0.8)+
    geom_hline(yintercept=c(20,-30), colour="gray15", linetype=3,linewidth=0.8)+                # 0 = blank, 1 = solid, 2 = dashed, 3 = dotted, 
            # 4 = dotdash, 5 = longdash, 6 = twodash
    annotate(geom = "text",x=c(2,50),y=c(-30,20),
             label = c("PR:-30%","PD:20%"),
             vjust = -0.5,
             )   

```

## 生存曲线 Kaplan-Meier curve：Fig.1 d、n

```{r}
### 数据 三列 “group”分组列， “time”生存时间列，“status”事件状态列
d<-read_excel("data/01source.xlsx",sheet=1,range = "A19:E75") |> 
  rename(
    LR_DPVB=`LR-DPVB`
  )  |> 
  pivot_longer(
    cols = CON:LR_DPVB,
    names_to = "treatment",
    values_to = "status"
  ) |> drop_na() |> 
  mutate(
    treatment=factor(treatment,levels=c('CON','LDRT','DPVB','LR_DPVB'))
  )
# 加载包
library(survival)

# 使用 Kaplan-Meier 方法拟合生存曲线
km_fit<-survfit(Surv(Days,status)~treatment,data=d)
summary(km_fit,data=d)
```

```{r}
plot(km_fit,
     lty = 1,
     col = c("gray","blue","orange3","darkred"),
     lwd = 2,
     )
```

```{r}
# 使用 ggplot2 和 survminer 绘制生存曲线图
library(survminer)
ggsurvplot(
    fit  = km_fit,
    data = d,
    fun = "pct",  #event',累计死亡比列，'cumhaz':cumulative hazard累计风险
    
    palette = "jco",
    linetype = c(1,5,4,6),
    surv.median.line = 'none',
    
    conf.int = TRUE,
    conf.int.alpha=0.5,
    
    pval = TRUE,# "log rank p=0.0053"
    log.rank.weights='1',  
    pval.method = TRUE,
    pval.coord=c(40,75),
    pval.method.coord=c(35,75),

    risk.table = "abs_pct", # "nrisk_cumcensor" and "nrisk_cumevents"
    risk.table.col = "treatment",
    tables.theme = theme_cleantable(),
    ncensor.plot=T,
    
    
    axes.offset=F,  #(0,0)pos
    title = "Hepa1-6 tumor",
    xlab="Days",
    ylab="Percent survival (%)",
    
    legend.title = "",
    legend = c(0.2,0.25),
    legend.labs=c('CON','LDRT','DPVB','LR_DPVB'),
    
    ggtheme = theme_survminer(),
    )


```

## 条形图+ errorbar + significance + dotplot：Fig.1 g、h、j、p

```{r}
g<-read_excel("data/01source.xlsx",sheet=1,range="G2:Z3") 
colnames(g) <- rep(c('CON','LDRT','DPVB','LR_DPVB'),each=5)
g<- g |>  pivot_longer(
  cols = everything(),
  names_to = "treatment",
  values_to = "liverweight"
  )|> 
  mutate(
    treatment=factor(treatment,levels=c('CON','LDRT','DPVB','LR_DPVB'))
  )
g
```

```{r}
source("function/calculate_t_tests.R")
calculate_t_tests(g,"treatment","liverweight")
```

::: callout-note
函数calculate_t_tests

```{r}
#| label: calculate_t_tests()
# 定义计算两两组之间t检验的函数
calculate_t_tests <- function(data, group_by, value_column) {
  # data: 数据框
  # group_by: 组别的列名
  # value_column: 要比较的数值的列名
  
  # 提取唯一的组别
  groups <- unique(data[[group_by]])
  
  # 初始化结果矩阵
  result_matrix <- matrix(NA, nrow = length(groups), ncol = length(groups),
                          dimnames = list(groups, groups))
  
  # 循环遍历所有可能的组合
  for (i in 1:(length(groups)-1)) {
    for (j in (i+1):length(groups)) {
      # 提取两组数据
      group1_data <- data[data[[group_by]] == groups[i], value_column]
      group2_data <- data[data[[group_by]] == groups[j], value_column]
      
      # 执行t检验
      t_test_result <- t.test(group1_data, group2_data)
      
      # 提取p值
      p_value <- t_test_result$p.value
      
      # 将p值存入结果矩阵
      #result_matrix[groups[i], groups[j]] <- p_value
      result_matrix[groups[j], groups[i]] <- p_value
    }
  }
  
  # 返回结果矩阵
  return(result_matrix)
}

```
:::

### 1

```{r}
library(ggpubr)
ggbarplot(data = g,
          x="treatment",y="liverweight",
          add = c("mean_sd"),
          fill = "treatment",
          palette = "jco",
          title = "DEN+CCl4 tumor",
          xlab = "",
          ylab='liver weight (g)',
          legend='none',
          )+
  stat_compare_means(
      #aes(label='p.format'),
      comparisons = list(c('CON','LDRT'),c("DPVB",'LR_DPVB'), c("CON","LR_DPVB")),
      method = 't.test',
      tip.length = c(0,0,0,0,0,0),
      bracket.size = 1,linewidth=1)+

  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45,vjust = 0.5))+
  geom_dotplot(data = g,
               mapping=aes(x=treatment,y=liverweight),
               binaxis = 'y',stackdir = 'center',binwidth = 0.05)

```

### 2

```{r}
library(ggsignif)
g |> 
  summarise(
    n=n(),
    mean=mean(liverweight),
    sd=sd(liverweight),
    .by=treatment
  ) |> 
    ggplot(aes(treatment,mean,fill=treatment))+
    geom_bar(stat = "identity",width = .7,position = position_dodge())+#条形图
    geom_errorbar(aes(ymin=mean-sd,ymax=mean+sd),
                  width=.2,color="black",linewidth=.8)+#误差棒
    geom_signif(data = g,
              mapping=aes(x=treatment,y=liverweight),
              comparisons = list(c('CON','LDRT'),c("DPVB",'LR_DPVB'),
                                 c("CON","LR_DPVB")),
              annotations = c("p=0.8639","p=0.0088","p=0.00034"),
              map_signif_level=F,
              tip_length=c(0.0,0.0,0.0,0.0,0.0,0.0),
              y_position=c(2.1,1.8,2.35),size = .8,
              textsize = 5,
              test = "t.test"
              )+
    theme_pubr()+
    scale_fill_jco()+
    scale_y_continuous(limits = c(0,2.5))+
    labs(
        x='',
        y='liver weight (g)',
        title="DEN+CCl4 tumor"
    )+
    theme(
        plot.title = element_text(hjust =0.5 ),
        legend.position = 'none',
        axis.text.x = element_text(angle = 45,vjust = .5)
    )+  
    geom_dotplot(data = g,
                 mapping=aes(x=treatment,y=liverweight),
                 binaxis = 'y',
                 stackdir = 'center',#居中
                 fill='black',
                 binwidth = 0.05)
  
```

### 3

```{r}
ggplot(g,aes(x=treatment,y=liverweight))+ 
    
    geom_bar(aes(fill=treatment),
           stat = 'summary',fun=mean,
           position = position_dodge(),width = .7) +
    
    stat_summary(fun.data = 'mean_sd',geom="errorbar",width=.2,linewidth=1) +
    
    geom_signif(comparisons = list(c('CON','LDRT'),c("DPVB",'LR_DPVB'),
                                 c("CON","LR_DPVB")),
                map_signif_level=F,
                tip_length=c(0,0,0,0,0,0),
                y_position=c(2.1,1.8,2.35),size = 0.8,
                test = "t.test",textsize = 5,
  )+
    geom_dotplot(data = g,
                 mapping=aes(x=treatment,y=liverweight),
                 binaxis = 'y',
                 stackdir = 'center',#居中
                 fill='black',
                 binwidth = 0.05)+
    theme_pubr()+
    scale_fill_jco()+
    scale_y_continuous(limits = c(0,2.5))+
    labs(
        x='',
        y='liver weight (g)',
        title="DEN+CCl4 tumor"
    )+
    theme(
        plot.title = element_text(hjust =0.5 ),
        legend.position = 'none',
        axis.text.x = element_text(angle = 45,vjust = .5)
    )
```

### 4 分组并列，组内显著性p值

<https://www.datanovia.com/en/blog/tag/ggpubr/>

<https://www.datanovia.com/en/blog/how-to-add-p-values-onto-a-grouped-ggplot-using-the-ggpubr-r-package/>

```{r}
f2e <- read_excel("data/01source.xlsx", sheet = 3, range = "A2:M4")
colnames(f2e) <-
    c("type", rep(c('CON', 'LDRT', 'DPVB', 'LR_DPVB'), each = 3))

f2e |> pivot_longer(cols = -1,
                    names_to = "trt",
                    values_to = "pct",
) |>
    mutate(trt = factor(trt, levels = c('CON', 'LDRT', 'DPVB', 'LR_DPVB'))) -> f2e
```

```{r}
library(ggpubr)
library(rstatix)

stat.test <- f2e %>%
  group_by(type) %>%
  t_test(pct ~ trt) |> 
  adjust_pvalue(method = "bonferroni") %>%
    add_significance("p.adj") |> 
    add_significance("p") 


stat.test <- stat.test %>%
  add_xy_position(fun = "mean_sd", x = "type", dodge = 1)|> 
  dplyr::filter(group1=="CON"&group2=="LR_DPVB")


e_left <- ggbarplot(f2e, x = "type", y = "pct",
                fill = "trt", palette = "jco",
                add =c("mean_sd"), add.params = list(group = "trt"),
                position = position_dodge(1),
                #legend="none",
          legend.title="",
          )+
    scale_y_continuous(limits = c(0,80))+
    stat_pvalue_manual(
        data = stat.test,
        label = "p={p}({p.signif})",
        tip.length = 0.05,
        y.position = c(40,75),
        #bracket.nudge.y = -2,
)+labs(
        x='',
        y='% in live CD45+ cell',
        #title="Hepa1-6 tumor"
    )

e_right <- e_left

(e_left + e_right)+
    plot_annotation(
        title = "Hepa1-6 tumor",
    ) +
    plot_layout(guides = "collect")& 
    theme(
        plot.title = element_text(hjust = 0.5),
        legend.position = "top",
    )
```

```{r}
ggplot(mpg, aes(x = drv, y = hwy, fill = as.factor(cyl))) +  
    geom_bar(stat = "summary",fun=mean, position = position_dodge(1)) +
    stat_summary(fun.data = 'mean_sd',geom="errorbar",position = position_dodge(1),
                 width=.2,linewidth=1)+
    geom_point(position = position_dodge(1), 
              size = 3,alpha=0.3
             )  
```

### 5 分组并列，组内组间显著性p值

<https://www.datanovia.com/en/blog/how-to-add-p-values-onto-a-grouped-ggplot-using-the-ggpubr-r-package/>

```{r}
library(ggpubr)
library(rstatix)
df <- ToothGrowth
df$dose <- as.factor(df$dose)



bp <- ggbarplot(
    df,
    x = "dose",
    y = "len",
    add = "mean_sd",
    color = "supp",
    palette = c("#00AFBB", "#E7B800"),
    position = position_dodge(0.8)
)


# 统计检验
stat.test <- df %>%
    group_by(dose) %>%
    t_test(len ~ supp) %>%
    adjust_pvalue(method = "bonferroni") %>%
    add_significance("p.adj")
stat.test <- stat.test %>%
    add_xy_position(fun = "mean_sd", x = "dose", dodge = 0.8)


stat.test2 <- df %>%
    t_test(len ~ dose, p.adjust.method = "bonferroni")
stat.test2 <- stat.test2 %>%
    add_xy_position(x = "dose")

pwc <- df %>%
    group_by(supp) %>%
    t_test(len ~ dose, p.adjust.method = "bonferroni")
pwc
pwc <- pwc %>%
    add_xy_position(
        x = "dose",
        fun = "mean_sd",
        group = "supp",
        dodge = 0.8
    )

# 组间组内复合


bp +
    stat_pvalue_manual(stat.test,  label = "p.adj.signif", tip.length = 0.01) +
    stat_pvalue_manual(
        stat.test2,
        label = "p",
        tip.length = 0.02,
        step.increase = 0.05
    ) +
    scale_y_continuous(expand = expansion(mult = c(0.05, 0.1))) +
    stat_pvalue_manual(
        pwc,
        color = "supp",
        step.group.by = "supp",
        tip.length = 0,
        step.increase = 0.1
    )
```

## 折线图：fig4 h

### 1

```{r}
f4h <-
    read_excel("data/01source.xlsx", sheet = "Fig.4", range = "A20:P23")
colnames(f4h) <-
    c("Days", rep(
        c("PBS", "SLAMF6+ PD-1+ CD8+ cells", "SLAMF6- PD-1+ CD8+ cells"),
        each = 5
    ))

f4h |> pivot_longer(cols = -1,
                    names_to = "method",
                    values_to = "volume",
) |>
    dplyr::mutate(Days = factor(Days, levels = c("-1", "7", "14")),
                  method = factor(
                      method,
                      levels = c("PBS", "SLAMF6+ PD-1+ CD8+ cells",
                                 "SLAMF6- PD-1+ CD8+ cells")
                  )) -> f4h
f4h <- rowid_to_column(f4h,var = "id")

```

统计p值

```{r}
# 重复测量方差设计
library(nlme)
model <- lme(volume ~ method*Days, random = ~1|id/Days, data = f4h)
summary(model)
df_aov <- anova(model)
df_aov

#成对比较
library(emmeans)
method_means <- emmeans(model, ~method)  
print(method_means)  
method_comparisons <- pairs(method_means)  
method_comparisons
```

```{r}
pvalue <- method_comparisons |> broom::tidy() |> 
    dplyr::select(contrast, adj.p.value) |> 
    dplyr::mutate(padj=round(adj.p.value,digits = 4),
                  p_adj_sci=format(adj.p.value,scientific = T,digits = 4))

pvalue

library(ggpubr)
p <- f4h |> summarise(
    mean_volume = mean(volume),
    sd = sd(volume),
    .by = c(Days, method),) |>
    ggplot(aes(
        x = Days,
        y = mean_volume,
        color = method,
        group = method,)) +
    geom_errorbar(
        aes(ymin = mean_volume - sd, ymax = mean_volume + sd),
        position = position_dodge(0),
        width = .2,
        linewidth = 0.5,
    ) +
    geom_line(position = position_dodge(0),
              linewidth = 0.8) +
    geom_point(
        aes(shape = method),
        position = position_dodge(0),
        color = "black",
        size = 2) +
    theme_pubr() +
    theme(legend.title = element_blank())

# 使用ggplot_build()获取图层数据
plot_data <- ggplot_build(p)

# 查看X轴的数值坐标
plot_data$data



p  +  annotate(geom = "segment",
               x = 3.4,
               y = 47.855824,
               yend = 2.876853,) + annotate(
                   geom = "text",
                   x = 3.45,
                   y = (47.855824 + 2.876853) / 2,
                   angle = 270,
                   label = pvalue$padj[2],
               ) +
    annotate(geom = "segment",
             x = 3.15,
             y = 47.855824,
             yend = 37.805035,) + annotate(
                 geom = "text",
                 x = 3.2,
                 y = (47.855824 + 37.805035) / 2,
                 angle = 270,
                 label = pvalue$padj[1],
             ) +
    annotate(geom = "segment",
             x = 3.3,
             y = 2.876853,
             yend = 37.805035,) + annotate(
                 geom = "text",
                 x = 3.35,
                 y = (2.876853 + 37.805035) / 2,
                 angle = 270,
                 label = pvalue$padj[3],
             )

#y=c(47.855824,37.805035,2.876853,),
#yend = c(2.876853,47.855824,37.805035,),
```

<https://www.datanovia.com/en/blog/how-to-add-p-values-onto-a-grouped-ggplot-using-the-ggpubr-r-package/>

### 2

```{r}
lp <- ggline(
    df,
    x = "dose",
    y = "len",
    add = "mean_sd",
    color = "supp",
    palette = c("#00AFBB", "#E7B800")
)
lp
# Add p-values onto the line plots
# Remove brackets using linetype = "blank"
stat.test <- stat.test %>%
    add_xy_position(fun = "mean_sd", x = "dose")
lp + stat_pvalue_manual(stat.test,
                        label = "p.adj.signif",
                        tip.length = 0,
                        linetype  = "blank")
```

## 拟合曲线R^2^ ,p值：f6c

```{r}
# 示例数据
df <- data.frame(
  x = 1:100,
  y = rnorm(100) + 2 * (1:100)  # 生成具有线性关系的x和y数据
)

# 创建基本的ggplot对象
p <- ggplot(df, aes(x = x, y = y))+
    geom_point(color='red')+
    geom_smooth(method = "lm",formula = "y~x",color="black",linewidth=.8)

# 使用stat_poly_eq()添加线性回归方程、R²和p值
p + ggpmisc::stat_poly_eq(formula = y ~ x,
                 ggpmisc::use_label(c("eq", "adj.R2", "P")))

```

## 点图

```{r}
f6d <-
    read_excel("data/01source.xlsx", sheet = "Fig.6", range = "D2:E18")
f6d |> pivot_longer(
    cols = everything(),
    names_to = "status",
    values_to = "Ratio",
    ) |> 
    tidyr::drop_na() ->f6d

ggdotplot(f6d,
          x="status",
          y="Ratio",
          add =c("mean_sd"),
          color = "status",
          fill = "status",
          error.plot = "errorbar",
          )+
    geom_signif(
        comparisons = list(c("relapse","non-relapse")),
    )+
    ggplot2::annotate(
        geom="segment",
        x=0.9,
        xend=1.1,
        y=2.42019873,#均值
    )+
    ggplot2::annotate(
        geom="segment",
        x=1.9,
        xend=2.1,
        y=0.789463173,#均值
    )
    
    
```

## 曼哈顿图

在医学科研中，曼哈顿图主要用来展示全基因组关联研究（GWAS）的数据。在R语言中，曼哈顿图可由qqman包绘制

![](data/qqman.png){fig-align="center"}

## ggcorrplot

```{r}
library(ggcorrplot)
data("iris")
cor<-cor(iris[,1:4])
ggcorrplot(cor)
p.mat <- ggcorrplot::cor_pmat(cor)
ggcorrplot(cor,hc.order=TRUE,lab=TRUE)

ggcorrplot(cor, hc.order = TRUE, p.mat = p.mat) + 
    labs(title = "鸢尾花数据集指标相关性") +
    theme(plot.title = element_text(hjust = 0.5))
```

## 韦恩图

　　一般来说, 超过 5 个集合后就不再适合使用韦恩图, 此时集合间重叠的信息难以辨认
